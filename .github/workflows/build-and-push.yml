name: Build and push to GHCR

on:
  workflow_dispatch:
    inputs:
      mod_version:
        description: 'Modpack version (e.g. 5.0.8)'
        required: true
        default: '5.0.8'
      mod_name:
        description: 'Modpack name (e.g. SkyFactory-5)'
        required: true
        default: 'SkyFactory-5'
      mod_package_url:
        description: 'Full URL to the modpack server ZIP'
        required: true
        default: 'https://mediafilez.forgecdn.net/files/6290/699/SkyFactory-5_Server_5.0.8.zip'
      skip_download:
        description: 'Skip remote download during image build (true/false)'
        required: false
        default: 'true'
      image_name:
        description: 'Optional image name (owner/repo). If empty will use repository owner and mod_name'
        required: false
        default: ''

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up buildx
        uses: docker/setup-buildx-action@v2

      - name: Determine image tag
        id: tag
        run: |
          MOD_NAME="${{ github.event.inputs.mod_name }}"
          MOD_VER="${{ github.event.inputs.mod_version }}"
          OWNER="${{ github.repository_owner }}"
          if [ -n "${{ github.event.inputs.image_name }}" ]; then
            TAG="ghcr.io/${{ github.event.inputs.image_name }}:${MOD_VER}"
          else
            SAFE_NAME=$(echo "$MOD_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9_.-]/_/g')
            TAG="ghcr.io/${OWNER}/${SAFE_NAME}:${MOD_VER}"
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.tag.outputs.tag }}
          build-args: |
            MINECRAFT_MOD_VERSION=${{ github.event.inputs.mod_version }}
            MINECRAFT_MOD_NAME=${{ github.event.inputs.mod_name }}
            MINECRAFT_MOD_PACKAGE=${{ github.event.inputs.mod_package_url }}
            SKIP_DOWNLOAD=${{ github.event.inputs.skip_download }}

      - name: Show result
        run: |
          echo "Pushed image: ${{ steps.tag.outputs.tag }}"
